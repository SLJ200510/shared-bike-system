<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜ - å…±äº«å•è½¦ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #adminMap {
            height: 500px;
            width: 100%;
            border-radius: 10px;
        }
        .stats-card {
            margin-bottom: 15px;
        }
        .bike-marker-available {
            background-color: #28a745;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .bike-marker-rented {
            background-color: #ffc107;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .bike-marker-maintenance {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .target-marker {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .map-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .order-details {
            max-height: 400px;
            overflow-y: auto;
        }
        .task-item {
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
        }
        .task-item.repair {
            border-left-color: #dc3545;
        }
        .task-item.dispatch {
            border-left-color: #28a745;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">å…±äº«å•è½¦ç®¡ç†ç³»ç»Ÿ - ç®¡ç†å‘˜</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">æ¬¢è¿ï¼Œ{{ username }}</span>
                <a class="btn btn-outline-light btn-sm" href="/logout">é€€å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>ç®¡ç†å‘˜æ§åˆ¶å°</h2>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">è½¦è¾†æ€»æ•°</h5>
                        <h2 id="totalBikes">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">å¯ç”¨è½¦è¾†</h5>
                        <h2 id="availableBikes">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">ç§Ÿç”¨ä¸­</h5>
                        <h2 id="rentedBikes">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-danger text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">ç»´ä¿®ä¸­</h5>
                        <h2 id="maintenanceBikes">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">ğŸ—ºï¸ è½¦è¾†åˆ†å¸ƒåœ°å›¾</h5>
                        <button class="btn btn-primary btn-sm" onclick="focusOnArea()">
                            ğŸ™ï¸ èšç„¦è¿è¡ŒåŒºåŸŸ
                        </button>
                    </div>
                    <div class="card-body position-relative">
                        <div id="adminMap"></div>
                        <div class="map-legend">
                            <small>
                                <div><span style="color: #28a745">â—</span> å¯ç”¨</div>
                                <div><span style="color: #ffc107">â—</span> ç§Ÿç”¨ä¸­</div>
                                <div><span style="color: #dc3545">â—</span> ç»´ä¿®ä¸­</div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- è½¦è¾†ç®¡ç†åŠŸèƒ½ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ğŸ”§ è½¦è¾†ç®¡ç†</h5>
                    </div>
                    <div class="card-body">
                        <!-- åˆ é™¤è½¦è¾† -->
                        <div class="mb-3">
                            <label class="form-label">åˆ é™¤å•è½¦</label>
                            <select class="form-select" id="deleteBikeSelect">
                                <option value="">è¯·é€‰æ‹©è¦åˆ é™¤çš„å•è½¦</option>
                            </select>
                        </div>
                        <button class="btn btn-danger w-100 mb-3" onclick="deleteBike()" id="deleteBtn" disabled>
                            ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­å•è½¦
                        </button>
                        
                        <hr>
                        
                        <!-- åˆ›å»ºæ–°è½¦è¾† -->
                        <div class="mb-3">
                            <label class="form-label">æ–°å•è½¦ç¼–å·</label>
                            <input type="text" class="form-control" id="newBikeId" placeholder="ä¾‹å¦‚: B013">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">åˆå§‹ä½ç½®</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="newBikeLat" placeholder="çº¬åº¦" step="0.0001">
                                <input type="number" class="form-control" id="newBikeLng" placeholder="ç»åº¦" step="0.0001">
                            </div>
                            <small class="text-muted">æˆ–åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ç½®</small>
                        </div>
                        <button class="btn btn-success w-100" onclick="createNewBike()" id="createBtn" disabled>
                            â• åˆ›å»ºæ–°å•è½¦
                        </button>
                    </div>
                </div>

                <!-- è°ƒåº¦åŠŸèƒ½ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ğŸšš è½¦è¾†è°ƒåº¦</h5>
                    </div>
                    <div class="card-body">
                        <div id="dispatchSection">
                            <div class="mb-3">
                                <label class="form-label">é€‰æ‹©å•è½¦</label>
                                <select class="form-select" id="bikeSelect">
                                    <option value="">è¯·é€‰æ‹©å•è½¦</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ç›®æ ‡ä½ç½®</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="targetLat" placeholder="çº¬åº¦" step="0.0001">
                                    <input type="number" class="form-control" id="targetLng" placeholder="ç»åº¦" step="0.0001">
                                </div>
                                <small class="text-muted">æˆ–åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ç½®</small>
                            </div>
                            <button class="btn btn-success w-100" onclick="createDispatch()" id="dispatchBtn" disabled>
                                åˆ›å»ºè°ƒåº¦ä»»åŠ¡
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘è®¢å• -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ğŸ“‹ æœ€è¿‘è®¢å•</h5>
                    </div>
                    <div class="card-body">
                        <div class="order-details">
                            <div id="recentOrders">
                                <div class="text-center text-muted">
                                    åŠ è½½ä¸­...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">è®¢å•è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailContent">
                        <!-- è®¢å•è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                    <div id="orderMap" style="height: 300px; margin-top: 15px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let adminMap;
        let bikeMarkers = [];
        let selectedBike = null;
        let targetMarker = null;

        // è¿è¡ŒåŒºåŸŸè¾¹ç•Œ
        const areaBounds = {
            minLat: 34.5000,
            maxLat: 34.7000,
            minLng: 112.1667,
            maxLng: 112.4167
        };

        // åŒºåŸŸä¸­å¿ƒç‚¹
        const areaCenter = [34.6000, 112.2917];

        // è‡ªå®šä¹‰å›¾æ ‡
        const createBikeIcon = (status) => {
            let color, className;
            switch(status) {
                case 'available':
                    color = '#28a745';
                    className = 'bike-marker-available';
                    break;
                case 'rented':
                    color = '#ffc107';
                    className = 'bike-marker-rented';
                    break;
                case 'maintenance':
                    color = '#dc3545';
                    className = 'bike-marker-maintenance';
                    break;
            }
            
            return L.divIcon({
                className: className,
                html: 'ğŸš²',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        };

        // åˆå§‹åŒ–åœ°å›¾
        function initAdminMap() {
            adminMap = L.map('adminMap').setView(areaCenter, 12);
            
            // ä½¿ç”¨é«˜å¾·åœ°å›¾
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '&copy; <a href="https://ditu.amap.com/">é«˜å¾·åœ°å›¾</a>'
            }).addTo(adminMap);

            // æ·»åŠ è¿è¡ŒåŒºåŸŸè¾¹ç•Œ
            const bounds = L.rectangle([
                [areaBounds.minLat, areaBounds.minLng],
                [areaBounds.maxLat, areaBounds.maxLng]
            ], {
                color: "#ff7800",
                weight: 2,
                fillOpacity: 0.1,
                dashArray: '5, 5'
            }).addTo(adminMap);
            
            bounds.bindPopup("è¿è¡ŒåŒºåŸŸèŒƒå›´");

            // åœ°å›¾ç‚¹å‡»äº‹ä»¶
            adminMap.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // è®¾ç½®è°ƒåº¦ç›®æ ‡ä½ç½®
                setTargetLocation(lat, lng);
                
                // åŒæ—¶è®¾ç½®æ–°è½¦ä½ç½®
                document.getElementById('newBikeLat').value = lat.toFixed(6);
                document.getElementById('newBikeLng').value = lng.toFixed(6);
                checkCreateReady();
            });

            loadAllBikes();
            loadStats();
            loadRecentOrders();
        }

        // èšç„¦åˆ°è¿è¡ŒåŒºåŸŸ
        function focusOnArea() {
            adminMap.setView(areaCenter, 11);
        }

        // åŠ è½½æ‰€æœ‰å•è½¦
        function loadAllBikes() {
            // æ¸…é™¤ç°æœ‰æ ‡è®°
            bikeMarkers.forEach(marker => adminMap.removeLayer(marker));
            bikeMarkers = [];
            
            fetch('/api/all_bikes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        data.bikes.forEach(bike => {
                            const icon = createBikeIcon(bike.status);
                            const marker = L.marker([bike.latitude, bike.longitude], { icon: icon })
                                .addTo(adminMap)
                                .bindPopup(`
                                    <div style="min-width: 200px">
                                        <strong>å•è½¦ ${bike.bike_id}</strong><br>
                                        çŠ¶æ€: <span style="color: ${
                                            bike.status === 'available' ? 'green' : 
                                            bike.status === 'rented' ? 'orange' : 'red'
                                        }">
                                            ${getStatusText(bike.status)}
                                        </span><br>
                                        ä½ç½®: (${bike.latitude.toFixed(4)}, ${bike.longitude.toFixed(4)})<br>
                                        <button class="btn btn-sm btn-outline-primary mt-1 w-100" onclick="selectBikeForDispatch('${bike.bike_id}')">
                                            è°ƒåº¦è¿™è¾†è½¦
                                        </button>
                                    </div>
                                `);
                            
                            bikeMarkers.push(marker);
                        });

                        // æ›´æ–°å•è½¦é€‰æ‹©ä¸‹æ‹‰æ¡†
                        updateBikeSelect(data.bikes);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å•è½¦æ•°æ®å¤±è´¥:', error);
                });
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch(status) {
                case 'available': return 'å¯ç”¨';
                case 'rented': return 'ç§Ÿç”¨ä¸­';
                case 'maintenance': return 'ç»´ä¿®ä¸­';
                default: return status;
            }
        }

        // æ›´æ–°å•è½¦é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateBikeSelect(bikes) {
            const bikeSelect = document.getElementById('bikeSelect');
            const deleteBikeSelect = document.getElementById('deleteBikeSelect');
            
            bikeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å•è½¦</option>';
            deleteBikeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦åˆ é™¤çš„å•è½¦</option>';
            
            bikes.forEach(bike => {
                if (bike.status !== 'rented') { // ä¸æ˜¾ç¤ºç§Ÿç”¨ä¸­çš„å•è½¦ç”¨äºè°ƒåº¦
                    const option = document.createElement('option');
                    option.value = bike.bike_id;
                    option.textContent = `å•è½¦ ${bike.bike_id} - ${getStatusText(bike.status)}`;
                    bikeSelect.appendChild(option);
                }
                
                // æ‰€æœ‰å•è½¦éƒ½å¯ä»¥åˆ é™¤ï¼ˆåŒ…æ‹¬ç§Ÿç”¨ä¸­çš„ï¼‰
                const deleteOption = document.createElement('option');
                deleteOption.value = bike.bike_id;
                deleteOption.textContent = `å•è½¦ ${bike.bike_id} - ${getStatusText(bike.status)}`;
                deleteBikeSelect.appendChild(deleteOption);
            });
            
            checkDeleteReady();
            checkCreateReady();
        }

        // é€‰æ‹©å•è½¦è¿›è¡Œè°ƒåº¦
        function selectBikeForDispatch(bikeId) {
            document.getElementById('bikeSelect').value = bikeId;
            selectedBike = bikeId;
            checkDispatchReady();
        }

        // è®¾ç½®ç›®æ ‡ä½ç½®
        function setTargetLocation(lat, lng) {
            document.getElementById('targetLat').value = lat.toFixed(6);
            document.getElementById('targetLng').value = lng.toFixed(6);
            
            // æ›´æ–°æˆ–æ·»åŠ ç›®æ ‡ä½ç½®æ ‡è®°
            if (targetMarker) {
                targetMarker.setLatLng([lat, lng]);
            } else {
                targetMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'target-marker',
                        html: 'ğŸ“',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(adminMap)
                .bindPopup('ç›®æ ‡ä½ç½®');
            }
            
            checkDispatchReady();
        }

        // æ£€æŸ¥è°ƒåº¦æ˜¯å¦å°±ç»ª
        function checkDispatchReady() {
            const bikeId = document.getElementById('bikeSelect').value;
            const targetLat = document.getElementById('targetLat').value;
            const targetLng = document.getElementById('targetLng').value;
            const dispatchBtn = document.getElementById('dispatchBtn');
            
            if (bikeId && targetLat && targetLng) {
                dispatchBtn.disabled = false;
            } else {
                dispatchBtn.disabled = true;
            }
        }

        // æ£€æŸ¥åˆ é™¤æ˜¯å¦å°±ç»ª
        function checkDeleteReady() {
            const bikeId = document.getElementById('deleteBikeSelect').value;
            const deleteBtn = document.getElementById('deleteBtn');
            deleteBtn.disabled = !bikeId;
        }

        // æ£€æŸ¥åˆ›å»ºæ˜¯å¦å°±ç»ª
        function checkCreateReady() {
            const bikeId = document.getElementById('newBikeId').value;
            const lat = document.getElementById('newBikeLat').value;
            const lng = document.getElementById('newBikeLng').value;
            const createBtn = document.getElementById('createBtn');
            
            createBtn.disabled = !(bikeId && lat && lng);
        }

        // åˆ›å»ºè°ƒåº¦ä»»åŠ¡
        function createDispatch() {
            const bikeId = document.getElementById('bikeSelect').value;
            const targetLat = parseFloat(document.getElementById('targetLat').value);
            const targetLng = parseFloat(document.getElementById('targetLng').value);
            
            // è·å–å•è½¦å½“å‰ä½ç½®
            const bike = bikeMarkers.find(marker => {
                const popup = marker.getPopup();
                return popup.getContent().includes(`å•è½¦ ${bikeId}`);
            });
            
            if (!bike) {
                alert('æœªæ‰¾åˆ°é€‰æ‹©çš„å•è½¦');
                return;
            }
            
            const fromLat = bike.getLatLng().lat;
            const fromLng = bike.getLatLng().lng;
            
            fetch('/api/create_dispatch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bike_id: bikeId,
                    from_lat: fromLat,
                    from_lng: fromLng,
                    to_lat: targetLat,
                    to_lng: targetLng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('è°ƒåº¦ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
                    // é‡ç½®è¡¨å•
                    document.getElementById('bikeSelect').value = '';
                    document.getElementById('targetLat').value = '';
                    document.getElementById('targetLng').value = '';
                    document.getElementById('dispatchBtn').disabled = true;
                    
                    if (targetMarker) {
                        adminMap.removeLayer(targetMarker);
                        targetMarker = null;
                    }
                } else {
                    alert('åˆ›å»ºè°ƒåº¦ä»»åŠ¡å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('åˆ›å»ºè°ƒåº¦ä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ›å»ºè°ƒåº¦ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // åˆ é™¤å•è½¦
        function deleteBike() {
            const bikeId = document.getElementById('deleteBikeSelect').value;
            
            if (!bikeId) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„å•è½¦');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å•è½¦ ${bikeId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            fetch('/api/delete_bike', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bike_id: bikeId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å•è½¦åˆ é™¤æˆåŠŸï¼');
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadAllBikes();
                    loadStats();
                    // é‡ç½®é€‰æ‹©
                    document.getElementById('deleteBikeSelect').value = '';
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å•è½¦å¤±è´¥:', error);
                alert('åˆ é™¤å•è½¦å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // åˆ›å»ºæ–°å•è½¦
        function createNewBike() {
            const bikeId = document.getElementById('newBikeId').value.trim();
            const lat = parseFloat(document.getElementById('newBikeLat').value);
            const lng = parseFloat(document.getElementById('newBikeLng').value);
            
            if (!bikeId) {
                alert('è¯·è¾“å…¥å•è½¦ç¼–å·');
                return;
            }
            
            if (!lat || !lng) {
                alert('è¯·é€‰æ‹©å•è½¦ä½ç½®');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨è¿è¡ŒåŒºåŸŸå†…
            if (lat < areaBounds.minLat || lat > areaBounds.maxLat || 
                lng < areaBounds.minLng || lng > areaBounds.maxLng) {
                alert('å•è½¦ä½ç½®å¿…é¡»åœ¨è¿è¡ŒåŒºåŸŸå†…ï¼');
                return;
            }
            
            fetch('/api/create_bike', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bike_id: bikeId,
                    latitude: lat,
                    longitude: lng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å•è½¦åˆ›å»ºæˆåŠŸï¼');
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadAllBikes();
                    loadStats();
                    // é‡ç½®è¡¨å•
                    document.getElementById('newBikeId').value = '';
                    document.getElementById('newBikeLat').value = '';
                    document.getElementById('newBikeLng').value = '';
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('åˆ›å»ºå•è½¦å¤±è´¥:', error);
                alert('åˆ›å»ºå•è½¦å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        function loadStats() {
            fetch('/api/admin_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalBikes').textContent = data.stats.total_bikes;
                        document.getElementById('availableBikes').textContent = data.stats.available_bikes;
                        document.getElementById('rentedBikes').textContent = data.stats.total_bikes - data.stats.available_bikes - data.stats.maintenance_bikes;
                        document.getElementById('maintenanceBikes').textContent = data.stats.maintenance_bikes;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                });
        }

        // åŠ è½½æœ€è¿‘è®¢å•
        function loadRecentOrders() {
            fetch('/api/admin_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const ordersContainer = document.getElementById('recentOrders');
                        if (data.recent_orders.length === 0) {
                            ordersContainer.innerHTML = '<div class="text-center text-muted">æš‚æ— è®¢å•</div>';
                            return;
                        }
                        
                        let ordersHTML = '';
                        data.recent_orders.forEach(order => {
                            const startTime = new Date(order.start_time).toLocaleString();
                            const endTime = order.end_time ? new Date(order.end_time).toLocaleString() : 'è¿›è¡Œä¸­';
                            const cost = order.cost ? `Â¥${order.cost.toFixed(2)}` : 'è®¡ç®—ä¸­';
                            
                            ordersHTML += `
                                <div class="card mb-2">
                                    <div class="card-body p-3">
                                        <h6 class="card-title">è®¢å•: ${order.order_id}</h6>
                                        <p class="card-text mb-1">
                                            <small>ç”¨æˆ·: ${order.username}</small><br>
                                            <small>å¼€å§‹: ${startTime}</small><br>
                                            <small>ç»“æŸ: ${endTime}</small><br>
                                            <small>è´¹ç”¨: ${cost}</small>
                                        </p>
                                        <button class="btn btn-sm btn-outline-info w-100" onclick="showOrderDetail('${order.order_id}')">
                                            æŸ¥çœ‹è¯¦æƒ…
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        ordersContainer.innerHTML = ordersHTML;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                    document.getElementById('recentOrders').innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥</div>';
                });
        }

        // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
        function showOrderDetail(orderId) {
            fetch('/api/admin_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const order = data.recent_orders.find(o => o.order_id === orderId);
                        if (order) {
                            showOrderDetailModal(order);
                        }
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                });
        }

        // æ˜¾ç¤ºè®¢å•è¯¦æƒ…æ¨¡æ€æ¡†
        function showOrderDetailModal(order) {
            const startTime = new Date(order.start_time).toLocaleString();
            const endTime = order.end_time ? new Date(order.end_time).toLocaleString() : 'è¿›è¡Œä¸­';
            const cost = order.cost ? `Â¥${order.cost.toFixed(2)}` : 'è®¡ç®—ä¸­';
            
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>è®¢å•ç¼–å·:</strong> ${order.order_id}</p>
                        <p><strong>ç”¨æˆ·å:</strong> ${order.username}</p>
                        <p><strong>å•è½¦ç¼–å·:</strong> ${order.bike_id}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>å¼€å§‹æ—¶é—´:</strong> ${startTime}</p>
                        <p><strong>ç»“æŸæ—¶é—´:</strong> ${endTime}</p>
                        <p><strong>è´¹ç”¨:</strong> ${cost}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p><strong>èµ·ç‚¹ä½ç½®:</strong><br>
                        çº¬åº¦: ${order.start_lat.toFixed(6)}<br>
                        ç»åº¦: ${order.start_lng.toFixed(6)}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>ç»ˆç‚¹ä½ç½®:</strong><br>
                        çº¬åº¦: ${order.end_lat ? order.end_lat.toFixed(6) : 'N/A'}<br>
                        ç»åº¦: ${order.end_lng ? order.end_lng.toFixed(6) : 'N/A'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('orderDetailContent').innerHTML = content;
            
            // åˆå§‹åŒ–è®¢å•åœ°å›¾
            const orderMap = L.map('orderMap').setView([order.start_lat, order.start_lng], 13);
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '&copy; <a href="https://ditu.amap.com/">é«˜å¾·åœ°å›¾</a>'
            }).addTo(orderMap);
            
            // æ·»åŠ èµ·ç‚¹æ ‡è®°
            L.marker([order.start_lat, order.start_lng])
                .addTo(orderMap)
                .bindPopup('èµ·ç‚¹')
                .openPopup();
            
            // å¦‚æœæœ‰ç»ˆç‚¹ï¼Œæ·»åŠ ç»ˆç‚¹æ ‡è®°
            if (order.end_lat && order.end_lng) {
                L.marker([order.end_lat, order.end_lng])
                    .addTo(orderMap)
                    .bindPopup('ç»ˆç‚¹');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initAdminMap();
            
            // ä¸ºè¡¨å•æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById('bikeSelect').addEventListener('change', checkDispatchReady);
            document.getElementById('targetLat').addEventListener('input', checkDispatchReady);
            document.getElementById('targetLng').addEventListener('input', checkDispatchReady);
            
            // æ–°å¢çš„è¡¨å•ç›‘å¬
            document.getElementById('deleteBikeSelect').addEventListener('change', checkDeleteReady);
            document.getElementById('newBikeId').addEventListener('input', checkCreateReady);
            document.getElementById('newBikeLat').addEventListener('input', checkCreateReady);
            document.getElementById('newBikeLng').addEventListener('input', checkCreateReady);
        });
    </script>
</body>
</html>